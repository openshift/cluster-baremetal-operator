# Cluster Baremetal Operator (CBO) - AI Agent Instructions

Instructions for AI coding agents. For project overview, see [README.md](README.md).

## Repository Structure

| Directory | Purpose |
|-----------|---------|
| `controllers/` | Reconciliation logic for Provisioning CR and ClusterOperator status |
| `provisioning/` | Metal3/BMO deployment creation, pod configs, secrets, image handling |
| `api/v1alpha1/` | Provisioning CRD types, validation, and webhooks |
| `config/` | Kustomize manifests (CRDs, RBAC, webhooks) - auto-generated by `make generate`, rarely edit directly |
| `manifests/` | Generated OpenShift manifests for operator deployment |
| `hack/` | Development scripts (prefer Make targets locally) |

## Testing Standards

Run these locally before submitting PRs:

**Make targets:**

| Command | Purpose |
|---------|---------|
| `make test` | Full verification (generate + lint + manifests + unit) |
| `make generate` | Regenerate Go code (deepcopy, CRDs, RBAC, webhooks) |
| `make manifests` | Generate OpenShift manifests (outputs to manifests/) |
| `make unit` | Unit tests (requires envtest) |
| `make lint` | Go linting via golangci-lint |
| `make vendor` | Update dependencies (tidy, vendor, verify) |
| `make bmh-crd` | Fetch BareMetalHost CRD from baremetal-operator |

## Code Conventions

- **Go**: Linting rules in `.golangci.yaml`, Go 1.24.0 (see go.mod)
- **OpenShift Dependencies**: Uses OpenShift fork of baremetal-operator (see go.mod replace directives)
- **Singleton CR**: Only one Provisioning CR per cluster (`provisioning-configuration`)

## Key Workflows

### Modifying APIs

1. Edit `api/v1alpha1/provisioning_types.go`
1. Run `make generate manifests`
1. Update validation in `api/v1alpha1/provisioning_validation.go` if needed
1. Update webhook in `api/v1alpha1/provisioning_webhook.go` if needed
1. Run `make test`

### Modifying Managed Resources

1. Edit relevant files in `provisioning/`:
   - `baremetal_pod.go` - Metal3 (Ironic) deployment
   - `bmo_pod.go` - Baremetal-operator deployment
   - `image_cache.go` - Image cache DaemonSet
   - `ironic_proxy.go` - Ironic proxy DaemonSet
1. Run `make test`
1. Add tests for new functionality

## Code Review Guidelines

When reviewing pull requests:

1. **Security** - Hardcoded secrets, unpinned dependencies, missing input validation
1. **Test coverage** - New functionality should have tests
1. **API compatibility** - Flag breaking changes to Provisioning CR
1. **Generated code** - Verify `make generate manifests` was run for API changes

Focus on: `controllers/`, `provisioning/`, `api/v1alpha1/`

## AI Agent Guidelines

### Before Changes

1. Run `make unit` to verify baseline
1. Check patterns in similar existing files

### When Making Changes

1. Make minimal, surgical edits
1. Run `make generate manifests` after API changes
1. Run `make test` before committing
1. Add tests for new functionality
1. Run `make vendor` if dependencies change
1. Run `make bmh-crd` if baremetal-operator version updated

### Security Requirements

- Pin external dependencies by SHA (containers, GitHub Actions, binaries)
- No hardcoded credentials
- Validate all inputs
- Use OpenShift fork of baremetal-operator (see go.mod replace directives)

### Testing Notes

- Test changes require overriding cluster-version-operator enforcement
- Never test in production environments
- Image changes require modifying `cluster-baremetal-operator-images` ConfigMap
- CBO pod restart needed after ConfigMap changes

## Related Documentation

- [README.md](README.md) - Project overview
- [OpenShift Bare Metal IPI Documentation](https://docs.openshift.com/container-platform/latest/installing/installing_bare_metal_ipi/ipi-install-overview.html)
